#!/bin/bash

# Setup Tests Script Ğ´Ğ»Ñ Contact Management API
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ñ–Ğ²

set -e  # Ğ—ÑƒĞ¿Ğ¸Ğ½Ğ¸Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ñ†Ñ–

echo "ğŸ§ª Contact Management API - ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ"
echo "=================================================="

# ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Python
echo "ğŸ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Python..."
python_version=$(python3 --version 2>&1 | awk '{print $2}')
echo "Ğ—Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Python $python_version"

if ! command -v python3 &> /dev/null; then
    echo "âŒ Python 3 Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ–Ñ‚ÑŒ Python 3.9+ Ñ‚Ğ° ÑĞ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ·Ğ½Ğ¾Ğ²Ñƒ."
    exit 1
fi

# Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
echo "ğŸ“¦ Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°..."
if [ ! -d "venv" ]; then
    python3 -m venv venv
    echo "âœ… Ğ’Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğµ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾"
else
    echo "âœ… Ğ’Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğµ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ Ğ²Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”"
fi

# ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ñ–Ñ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
echo "ğŸ”Œ ĞĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ñ–Ñ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°..."
source venv/bin/activate || source venv/Scripts/activate 2>/dev/null || {
    echo "âŒ ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ°ĞºÑ‚Ğ¸Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğµ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ"
    exit 1
}

# ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ pip
echo "â¬†ï¸ ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ pip..."
python -m pip install --upgrade pip

# Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
echo "ğŸ“š Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ñ… Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹..."
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
    echo "âœ… ĞÑĞ½Ğ¾Ğ²Ğ½Ñ– Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ–"
else
    echo "âŒ Ğ¤Ğ°Ğ¹Ğ» requirements.txt Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
    exit 1
fi

echo "ğŸ§ª Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¸Ñ… Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹..."
if [ -f "requirements-test.txt" ]; then
    pip install -r requirements-test.txt
    echo "âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ– Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ–"
else
    echo "âŒ Ğ¤Ğ°Ğ¹Ğ» requirements-test.txt Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
    exit 1
fi

# Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ½ĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ğ¸Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ğ¹
echo "ğŸ“ Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ğ¹..."
mkdir -p tests/unit tests/integration htmlcov
echo "âœ… Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ñ— ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ñ–"

# ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Docker (Ğ¾Ğ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
echo "ğŸ³ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Docker..."
if command -v docker &> /dev/null; then
    echo "âœ… Docker Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
    
    echo "ğŸ—„ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ñ— Ğ±Ğ°Ğ·Ğ¸ Ğ´Ğ°Ğ½Ğ¸Ñ…..."
    docker-compose -f docker-compose.test.yaml up -d test-db test-redis
    
    echo "â³ ĞÑ‡Ñ–ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ñ– ÑĞµÑ€Ğ²Ñ–ÑÑ–Ğ²..."
    sleep 10
    
    echo "âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ– ÑĞµÑ€Ğ²Ñ–ÑĞ¸ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ñ–"
else
    echo "âš ï¸ Docker Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾. Ğ¢ĞµÑÑ‚Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒĞ²Ğ°Ñ‚Ğ¸ SQLite."
fi

# ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ¸Ñ… ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
echo "ğŸ”§ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ¸Ñ… ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°..."
cat > .env.test << EOF
# Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
TESTING=true
DB_HOST=localhost
DB_PORT=5434
DB_NAME=test_contacts_db
DB_USER=test_user
DB_PASSWORD=test_password
SECRET_KEY=test-secret-key-change-in-production
REDIS_HOST=localhost
REDIS_PORT=6380
MAIL_USERNAME=test@example.com
MAIL_PASSWORD=test_password
CLOUDINARY_NAME=test_cloud
CLOUDINARY_API_KEY=test_key
CLOUDINARY_API_SECRET=test_secret
EOF
echo "âœ… Ğ¤Ğ°Ğ¹Ğ» .env.test ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¸Ğ¹"

# ĞŸĞµÑ€ÑˆĞ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ñ–Ğ²
echo "ğŸš€ ĞŸĞµÑ€ÑˆĞ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ñ–Ğ²..."
echo "=========================="

# Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ ÑˆĞ²Ğ¸Ğ´ĞºÑ– unit Ñ‚ĞµÑÑ‚Ğ¸
echo "ğŸ”¬ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ¸Ñ… Ñ‚ĞµÑÑ‚Ñ–Ğ²..."
python -m pytest tests/ -m unit -v --tb=short || {
    echo "âŒ ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ– Ñ‚ĞµÑÑ‚Ğ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¸"
    echo "ğŸ’¡ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ğ²Ğ¸Ñ‰Ğµ Ñ‚Ğ° Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ñ‚Ğµ ĞºĞ¾Ğ´"
}

# ĞŸĞ¾Ñ‚Ñ–Ğ¼ Ñ–Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ğ¹Ğ½Ñ– Ñ‚ĞµÑÑ‚Ğ¸
echo "ğŸ”— Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ–Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ğ¹Ğ½Ğ¸Ñ… Ñ‚ĞµÑÑ‚Ñ–Ğ²..."
python -m pytest tests/ -m integration -v --tb=short || {
    echo "âŒ Ğ†Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ğ¹Ğ½Ñ– Ñ‚ĞµÑÑ‚Ğ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¸"
    echo "ğŸ’¡ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ Ğ´Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ñ— Ğ‘Ğ”"
}

# ĞŸĞ¾Ğ²Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ· Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚ÑĞ¼
echo "ğŸ“Š Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ÑÑ–Ñ… Ñ‚ĞµÑÑ‚Ñ–Ğ² Ğ· Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚ÑĞ¼..."
python -m pytest tests/ \
    --cov=app \
    --cov-report=html:htmlcov \
    --cov-report=term-missing \
    --cov-fail-under=75 \
    -v

# Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸
echo ""
echo "ğŸ‰ ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!"
echo "========================="
echo ""
echo "ğŸ“ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ñ– ĞºÑ€Ğ¾ĞºĞ¸:"
echo "  1. ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑŒÑ‚Ğµ Ğ·Ğ²Ñ–Ñ‚ Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ: open htmlcov/index.html"
echo "  2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ñ–Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¸: make test"
echo "  3. Ğ§Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ñ–Ñ: cat TESTING.md"
echo ""
echo "ğŸ› ï¸ ĞšĞ¾Ñ€Ğ¸ÑĞ½Ñ– ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¸:"
echo "  make test              # Ğ’ÑÑ– Ñ‚ĞµÑÑ‚Ğ¸ Ğ· Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚ÑĞ¼"
echo "  make test-unit         # Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ– Ñ‚ĞµÑÑ‚Ğ¸"
echo "  make test-integration  # Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ñ–Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ğ¹Ğ½Ñ– Ñ‚ĞµÑÑ‚Ğ¸"
echo "  make test-coverage     # Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ·Ğ²Ñ–Ñ‚ Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ"
echo "  make clean             # ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ñ„Ğ°Ğ¹Ğ»Ğ¸"
echo ""
echo "ğŸ“š Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ñ–Ñ:"
echo "  TESTING.md             # ĞŸĞ¾Ğ²Ğ½Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ñ–Ñ Ğ¿Ğ¾ Ñ‚ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ"
echo "  README.md              # Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ñ–Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ"
echo ""

# ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿Ğ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ
coverage_percent=$(python -m coverage report | tail -1 | awk '{print $4}' | sed 's/%//')
if [ "$coverage_percent" -ge 75 ]; then
    echo "âœ… ĞŸĞ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸: $coverage_percent% (â‰¥75% âœ“)"
else
    echo "âŒ ĞŸĞ¾ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸: $coverage_percent% (<75% âœ—)"
    echo "ğŸ’¡ Ğ”Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ñ–Ğ»ÑŒÑˆĞµ Ñ‚ĞµÑÑ‚Ñ–Ğ² Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑĞ³Ğ½ĞµĞ½Ğ½Ñ 75%+"
fi

echo ""
echo "ğŸ¯ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: Ğ¢ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğµ Ğ´Ğ¾ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ½Ğ½Ñ!"